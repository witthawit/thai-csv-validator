<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Data CSV Validator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="container bg-white p-8 rounded-lg shadow-xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Thai Data CSV Validator</h1>
        <p class="text-center text-gray-600 mb-8">Upload a CSV file to validate Thai ID, Address, and Full Name.</p>

        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            <input 
                type="file" 
                id="file-input" 
                accept=".csv" 
                class="block w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-violet-50 file:text-violet-700
                       hover:file:bg-violet-100"
            />
            <button 
                id="validate-button" 
                class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg
                       hover:bg-indigo-700 transition duration-300 ease-in-out"
            >
                Validate
            </button>
        </div>

        <div id="loading-indicator" class="hidden text-center text-indigo-600 mb-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto mb-2"></div>
            Validating data...
        </div>

        <div id="results-container" class="mt-8 overflow-x-auto">
            <!-- Results table will be rendered here -->
        </div>

        <!-- Custom Modal for Errors -->
        <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Error</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="error-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-input');
            const validateButton = document.getElementById('validate-button');
            const resultsContainer = document.getElementById('results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            /**
             * Displays an error message in a modal.
             * @param {string} message - The error message to display.
             */
            function showError(message) {
                errorMessage.textContent = message;
                errorModal.classList.remove('hidden');
            }

            // Close the error modal
            closeModalBtn.addEventListener('click', () => {
                errorModal.classList.add('hidden');
            });

            /**
             * Hides the loading indicator and enables the validate button.
             */
            function toggleLoading(isLoading) {
                if (isLoading) {
                    loadingIndicator.classList.remove('hidden');
                    validateButton.disabled = true;
                    validateButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    loadingIndicator.classList.add('hidden');
                    validateButton.disabled = false;
                    validateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            validateButton.addEventListener('click', () => {
                const file = fileInput.files[0];
                if (!file) {
                    showError("Please select a CSV file first.");
                    return;
                }

                toggleLoading(true);

                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    processCSV(text);
                };
                reader.onerror = function() {
                    showError("Failed to read the file.");
                    toggleLoading(false);
                };
                
                // *** REVISED LINE: Changing encoding to UTF-8, which is the most common standard. ***
                reader.readAsText(file, 'UTF-8');
            });

            /**
             * Processes the CSV text and initiates validation.
             * @param {string} csvText - The raw CSV content as a string.
             */
            function processCSV(csvText) {
                try {
                    const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        showError("CSV file is empty or has no data rows.");
                        toggleLoading(false);
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim());
                    const data = lines.slice(1).map(line => {
                        const values = line.split(',');
                        let row = {};
                        headers.forEach((header, i) => {
                            row[header] = values[i] ? values[i].trim() : '';
                        });
                        return row;
                    });
                    
                    const validatedData = validateData(data);
                    renderResults(validatedData);
                } catch (error) {
                    console.error("Error processing CSV:", error);
                    showError("An error occurred while processing the CSV file.");
                } finally {
                    toggleLoading(false);
                }
            }

            /**
             * Validates each row of data against the specified rules.
             * @param {Array<Object>} data - The parsed CSV data.
             * @returns {Array<Object>} The data with validation results added.
             */
            function validateData(data) {
                return data.map(row => {
                    const validation = {
                        idCard: validateThaiId(row['thai_id_card']),
                        address: validateThaiAddress(row['address']),
                        fullName: validateThaiName(row['full_name'])
                    };
                    const isValid = validation.idCard.isValid && validation.address.isValid && validation.fullName.isValid;
                    return { ...row, validation, isValid };
                });
            }

            /**
             * Renders the validation results in a table.
             * @param {Array<Object>} validatedData - The data with validation results.
             */
            function renderResults(validatedData) {
                const totalRows = validatedData.length;
                const validRows = validatedData.filter(row => row.isValid).length;
                
                const summaryHtml = `
                    <div class="mb-4 p-4 rounded-lg bg-gray-50 shadow-inner">
                        <p class="text-lg font-semibold text-gray-700">Validation Summary</p>
                        <p class="text-sm text-gray-500">Total Rows: ${totalRows} | Valid Rows: ${validRows} | Invalid Rows: ${totalRows - validRows}</p>
                    </div>
                `;

                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg shadow-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thai ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Errors</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;

                validatedData.forEach(row => {
                    const statusIcon = row.isValid 
                        ? `<svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`
                        : `<svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
                    
                    const errors = [];
                    if (!row.validation.idCard.isValid) errors.push(row.validation.idCard.error);
                    if (!row.validation.address.isValid) errors.push(row.validation.address.error);
                    if (!row.validation.fullName.isValid) errors.push(row.validation.fullName.error);
                    
                    const errorList = errors.map(err => `<li class="text-red-500 text-sm">${err}</li>`).join('');

                    tableHtml += `
                        <tr class="${row.isValid ? 'bg-green-50' : 'bg-red-50'}">
                            <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center justify-center">${statusIcon}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row['thai_id_card']}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row['full_name']}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">${row['address']}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                ${errors.length > 0 ? `<ul class="list-disc list-inside">${errorList}</ul>` : 'No errors'}
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `</tbody></table>`;
                resultsContainer.innerHTML = summaryHtml + tableHtml;
            }

            /**
             * Validates a Thai National ID card number using the checksum algorithm.
             * @param {string} id - The 13-digit ID number.
             * @returns {{isValid: boolean, error: string}}
             */
            function validateThaiId(id) {
                const normalizedId = String(id).replace(/\s/g, ''); // Remove spaces
                if (!/^\d{13}$/.test(normalizedId)) {
                    return { isValid: false, error: 'Invalid ID format.' };
                }
                const numbers = normalizedId.split('').map(Number);
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += numbers[i] * (13 - i);
                }
                const checkDigit = (11 - (sum % 11)) % 10;
                if (checkDigit !== numbers[12]) {
                    return { isValid: false, error: 'Invalid checksum.' };
                }
                return { isValid: true, error: null };
            }

            /**
             * A simplified check for a valid Thai address.
             * NOTE: This is a basic regex-based check and not a definitive validation.
             * A full validation would require a comprehensive address database.
             * @param {string} address - The address string.
             * @returns {{isValid: boolean, error: string}}
             */
            function validateThaiAddress(address) {
                const thaiAddressKeywords = /ตำบล|อำเภอ|จังหวัด|เขต|แขวง/g;
                if (!address || !thaiAddressKeywords.test(address)) {
                    return { isValid: false, error: 'Missing key Thai address components.' };
                }
                return { isValid: true, error: null };
            }

            /**
             * Checks if a string contains at least one Thai character.
             * @param {string} name - The name string.
             * @returns {{isValid: boolean, error: string}}
             */
            function validateThaiName(name) {
                const thaiCharRegex = /[\u0E00-\u0E7F]/;
                if (!name || !thaiCharRegex.test(name)) {
                    return { isValid: false, error: 'Does not contain Thai characters.' };
                }
                return { isValid: true, error: null };
            }
        });
    </script>
</body>
</html>
